<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="canonical" href="https://www.taze.rw/cart.html" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopping Cart | Taze</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* General Styles */
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
    }

    /* Header */
    header {
      background: linear-gradient(135deg, #6e7969, #20c997);
      color: white;
      text-align: center;
      padding: 4rem 2rem;
      position: relative;
    }

    .header-content {
      position: relative;
      z-index: 2;
    }

    header h1 {
      font-size: 2.5rem;
      margin: 0;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6);
    }

    header h3 {
      font-size: 1.3rem;
      font-weight: normal;
      margin-top: 8px;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
    }

    /* Back Button Styling */
    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: white;
      color: #000000;
      padding: 8px 15px;
      font-size: 1rem;
      border-radius: 5px;
      text-decoration: none;
      font-weight: bold;
      transition: background 0.3s ease-in-out;
      z-index: 3;
    }

    .back-btn:hover {
      background-color: #f4f4f4;
    }

    /* Cart Container */
    .cart-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 1.5rem;
      background-color: white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }

    .empty-cart {
      text-align: center;
      padding: 3rem;
      color: #666;
    }

    .empty-cart i {
      font-size: 4rem;
      margin-bottom: 1rem;
      color: #ddd;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #f4f4f4;
      font-size: 1.2rem;
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quantity-controls button {
      padding: 5px 10px;
      font-size: 1rem;
      border: none;
      background-color: #ddd;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .quantity-controls button:hover {
      background-color: #bbb;
    }

    .remove-btn {
      color: #dc3545;
      cursor: pointer;
      text-decoration: underline;
      font-size: 0.9rem;
      font-weight: bold;
    }

    .remove-btn:hover {
      color: #c82333;
    }

    .summary-container {
      margin-top: 20px;
      padding: 15px;
      border-top: 2px solid #ddd;
      background: #f8f9fa;
      border-radius: 5px;
    }

    .summary-container p {
      font-size: 1.1rem;
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
    }

    .checkout-container {
      margin-top: 15px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    .checkout-container input,
    .checkout-container select,
    .checkout-container textarea {
      width: 100%;
      padding: 10px;
      font-size: 1rem;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    }

    .delivery-option {
      padding: 12px;
      font-size: 1rem;
      background: white;
      border: 2px solid #ddd;
      border-radius: 5px;
    }

    .note-box {
      background-color: #d4edda;
      padding: 15px;
      border-radius: 5px;
      font-size: 0.95rem;
      color: #155724;
      margin: 15px 0;
      border: 1px solid #c3e6cb;
    }

    .checkout-btn {
      display: block;
      width: 100%;
      padding: 15px;
      font-size: 1.2rem;
      background-color: #6e7969;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease-in-out;
      text-align: center;
      margin-top: 15px;
      font-weight: bold;
    }

    .checkout-btn:hover {
      background-color: #5a6459;
    }

    .checkout-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    /* Loading Animation */
    .loading {
      display: none;
      text-align: center;
      margin: 20px 0;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #6e7969;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Success Message */
    .success-message {
      display: none;
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      border: 1px solid #c3e6cb;
      text-align: center;
    }

    footer {
      background-color: #333;
      color: white;
      text-align: center;
      padding: 1rem;
      margin-top: 2rem;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .cart-container {
        margin: 1rem;
        padding: 1rem;
      }

      table {
        font-size: 0.9rem;
      }

      th, td {
        padding: 8px;
      }

      header h1 {
        font-size: 2rem;
      }

      header h3 {
        font-size: 1.1rem;
      }
    }
  </style>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

  <!-- Header -->
  <header>
    <a href="javascript:history.back()" class="back-btn">‚Üê Back</a>
    <div class="header-content">
      <h1>Shopping Cart</h1>
      <h3>Review Your Items Before Checkout</h3>
    </div>
  </header>

  <!-- Cart Container -->
  <div class="cart-container">
    <div id="cart-content">
      <table id="cart-table">
        <thead>
          <tr>
            <th>Product</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Total</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="cart-items"></tbody>
      </table>

      <div class="summary-container">
        <p><strong>Subtotal:</strong> <span id="subtotal">RWF 0</span></p>
        <p>
          <strong>Delivery Method:</strong> 
          <select id="delivery-option" class="delivery-option" onchange="updateTotal()">
            <option value="0">Select Delivery Method</option>
            <option value="2000">Motorcycle Delivery - RWF 2,000</option>
            <option value="8000">Car Delivery (Rifan) - RWF 8,000</option>
          </select>
        </p>
        <p style="border-top: 1px solid #ddd; padding-top: 10px; margin-top: 15px;">
          <strong style="color: #6e7969;">Grand Total:</strong> 
          <span id="grand-total" style="color: #6e7969; font-size: 1.3em; font-weight: bold;">RWF 0</span>
        </p>

        <div class="checkout-container">
          <div class="form-group">
            <label for="customer-name">Full Name *</label>
            <input type="text" id="customer-name" placeholder="Enter your full name" required>
          </div>

          <div class="form-group">
            <label for="customer-phone">Phone Number *</label>
            <input type="tel" id="customer-phone" placeholder="Enter your phone number (e.g., +250 788 123 456)" required>
          </div>

          <div class="form-group">
            <label for="customer-email">Email Address (Optional)</label>
            <input type="email" id="customer-email" placeholder="Enter your email address">
          </div>

          <div class="form-group">
            <label for="customer-location">Delivery Address *</label>
            <textarea id="customer-location" rows="3" placeholder="Enter your full delivery address (District, Sector, Cell, detailed location)" required></textarea>
          </div>

          <div class="form-group">
            <label for="order-notes">Special Instructions (Optional)</label>
            <textarea id="order-notes" rows="2" placeholder="Any special delivery instructions or notes..."></textarea>
          </div>

          <div class="note-box">
            <i class="fas fa-info-circle"></i>
            After clicking "Proceed to Payment", your order details will be sent to our team and you'll be redirected to complete payment. Delivery time: 30 minutes - 1 hour.
          </div>

          <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processing your order...</p>
          </div>

          <div class="success-message" id="success-message">
            <i class="fas fa-check-circle"></i>
            Order submitted successfully! You'll be redirected to payment shortly.
          </div>

          <button class="checkout-btn" id="checkout-btn" onclick="proceedToPayment()">
            <i class="fas fa-credit-card"></i> Proceed to Payment
          </button>
        </div>
      </div>
    </div>

    <!-- Empty Cart Message -->
    <div class="empty-cart" id="empty-cart" style="display: none;">
      <i class="fas fa-shopping-cart"></i>
      <h3>Your cart is empty</h3>
      <p>Add some delicious items to get started!</p>
      <a href="index.html" style="color: #6e7969; text-decoration: none; font-weight: bold;">
        <i class="fas fa-arrow-left"></i> Continue Shopping
      </a>
    </div>
  </div>

  <!-- Footer -->
  <footer>&copy; 2024 Taze.rw. All rights reserved.</footer>

  <script>
  const PRODUCTS_URL = "products.json"; // adjust path if needed

  let cart = JSON.parse(localStorage.getItem("cart")) || [];
  let productsMap = {};

  function formatPrice(price) {
    return `RWF ${price.toLocaleString()}`;
  }

  /* ===============================
     LOAD PRODUCTS FROM JSON
  =============================== */
  async function loadProducts() {
    try {
      const res = await fetch(PRODUCTS_URL);
      const data = await res.json();
      data.products.forEach(p => {
        productsMap[p.id] = p;
      });
    } catch (err) {
      console.error("Failed to load products.json", err);
      alert("Failed to load products. Please refresh.");
    }
  }

  /* ===============================
     LOAD CART ITEMS
  =============================== */
  function loadCartItems() {
    const cartItemsContainer = document.getElementById("cart-items");
    const cartContent = document.getElementById("cart-content");
    const emptyCart = document.getElementById("empty-cart");

    if (cart.length === 0) {
      cartContent.style.display = "none";
      emptyCart.style.display = "block";
      return;
    }

    cartContent.style.display = "block";
    emptyCart.style.display = "none";
    cartItemsContainer.innerHTML = "";

    let subtotal = 0;

    cart.forEach((cartItem, index) => {
      const product = productsMap[cartItem.id];
      if (!product) return;

      const quantity = Number(cartItem.quantity || 1);
      const itemTotal = product.price * quantity;
      subtotal += itemTotal;

      cartItemsContainer.innerHTML += `
        <tr>
          <td>
            <strong>${product.name}</strong><br>
            <small style="color:#666">${product.category} / ${product.subcategory}</small>
          </td>
          <td>${formatPrice(product.price)}</td>
          <td>
            <div class="quantity-controls">
              <button onclick="updateQuantity(${index}, -1)" ${cartItem.quantity <= 1 ? "disabled" : ""}>-</button>
              <span style="margin:0 10px;font-weight:bold">${cartItem.quantity}</span>
              <button onclick="updateQuantity(${index}, 1)">+</button>
            </div>
          </td>
          <td><strong>${formatPrice(itemTotal)}</strong></td>
          <td>
            <span class="remove-btn" onclick="removeItem(${index})">
              <i class="fas fa-trash"></i> Remove
            </span>
          </td>
        </tr>
      `;
    });

    document.getElementById("subtotal").innerText = formatPrice(subtotal);
    updateTotal();
  }

  /* ===============================
     CART ACTIONS
  =============================== */
  function updateQuantity(index, change) {
  cart[index].quantity = Math.max(1, Number(cart[index].quantity) + change);
  localStorage.setItem("cart", JSON.stringify(cart));
  loadCartItems();
}


  function removeItem(index) {
    if (confirm("Remove this item from cart?")) {
      cart.splice(index, 1);
      localStorage.setItem("cart", JSON.stringify(cart));
      loadCartItems();
    }
  }

  function updateTotal() {
    const subtotal = cart.reduce((sum, item) => {
      const product = productsMap[item.id];
      return product ? sum + product.price * item.quantity : sum;
    }, 0);

    const deliveryFee = parseInt(document.getElementById("delivery-option").value) || 0;
    const grandTotal = subtotal + deliveryFee;

    document.getElementById("grand-total").innerText = formatPrice(grandTotal);
  }

  /* ===============================
     FORM VALIDATION
  =============================== */
  function validateForm() {
    const requiredFields = [
      "customer-name",
      "customer-phone",
      "customer-location"
    ];

    for (let id of requiredFields) {
      const el = document.getElementById(id);
      if (!el.value.trim()) {
        alert("Please fill all required fields.");
        el.focus();
        return false;
      }
    }

    if (cart.length === 0) {
      alert("Your cart is empty.");
      return false;
    }

    return true;
  }

  /* ===============================
   SEND ORDER EMAIL (FIXED)
=============================== */
async function sendOrderEmail(orderData) {
  try {
    const response = await fetch("/.netlify/functions/sendOrderEmail", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        orderId: orderData.orderId,
        cartItems: orderData.cartItems,
        totalAmount: {
          subtotal: orderData.subtotal,
          deliveryFee: orderData.deliveryFee,
          grandTotal: orderData.grandTotal
        },
        customerInfo: {
          name: orderData.name,
          phone: orderData.phone,
          email: orderData.email
        },
        deliveryInfo: {
          method: orderData.deliveryMethod,
          address: orderData.location,
          notes: orderData.notes
        }
      })
    });

    const result = await response.json();

    if (!response.ok) {
      throw new Error(result.error || "Email failed");
    }

    return result;
  } catch (error) {
    console.error("Error sending email:", error);
    throw error;
  }
}

/* ===============================
   PROCEED TO PAYMENT (FIXED)
=============================== */
async function proceedToPayment() {
  if (!validateForm()) return;

  const name = document.getElementById("customer-name").value.trim();
  const phone = document.getElementById("customer-phone").value.trim();
  const email = document.getElementById("customer-email").value.trim();
  const location = document.getElementById("customer-location").value.trim();
  const notes = document.getElementById("order-notes").value.trim();

  const deliveryOption = document.getElementById("delivery-option");
  const deliveryFee = parseInt(deliveryOption.value);
  const deliveryMethod = deliveryOption.options[deliveryOption.selectedIndex].text;

  // Check if delivery method is selected
  if (deliveryFee === 0) {
    alert("Please select a delivery method.");
    deliveryOption.focus();
    return;
  }

  // Calculate totals
  let subtotal = 0;
  const cartItems = cart.map(item => {
    const p = productsMap[item.id];
    if (!p) return null;
    
    const itemTotal = p.price * item.quantity;
    subtotal += itemTotal;
    
    return {
      id: p.id,
      name: p.name,
      price: p.price,
      quantity: item.quantity,
      total: itemTotal
    };
  }).filter(item => item !== null);

  const grandTotal = subtotal + deliveryFee;
  const orderId = "TZ" + Date.now().toString().slice(-8);

  // Show loading
  const loadingEl = document.getElementById("loading");
  const checkoutBtn = document.getElementById("checkout-btn");
  loadingEl.style.display = "block";
  checkoutBtn.disabled = true;

  try {
    // Send order email
    await sendOrderEmail({
      orderId,
      cartItems,
      subtotal,
      deliveryFee,
      grandTotal,
      name,
      phone,
      email,
      location,
      notes,
      deliveryMethod
    });

    // Show success message
    loadingEl.style.display = "none";
    const successMsg = document.getElementById("success-message");
    successMsg.style.display = "block";

    // Save order to localStorage
    localStorage.setItem("currentOrder", JSON.stringify({
      orderId,
      name,
      phone,
      email,
      location,
      notes,
      cart: cartItems,
      subtotal,
      deliveryFee,
      grandTotal,
      deliveryMethod
    }));

    // Clear cart and redirect to payment
    localStorage.setItem("cart", JSON.stringify([]));
    
    setTimeout(() => {
      window.location.href = "payment.html";
    }, 2000);

  } catch (error) {
    // Hide loading
    loadingEl.style.display = "none";
    checkoutBtn.disabled = false;
    
    alert("Failed to process order. Please try again or contact support.");
    console.error("Order processing error:", error);
  }
}

  /* ===============================
     INIT
  =============================== */
  document.addEventListener("DOMContentLoaded", async () => {
    await loadProducts();
    loadCartItems();
  });
</script>


</body>
</html>